import prisma from "@/lib/prisma";
import { NextRequest, NextResponse } from "next/server";
import QRCode from "qrcode";
import { getPublicBaseUrl } from "@/lib/baseUrl";

/**
 * HTTP GET request to /api/event/[id]/flyer
 * @returns SVG flyer with event title and QR code
 */
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id: eventId } = await params;

  try {
    const event = await prisma.event.findUnique({
      where: { id: eventId },
      select: {
        id: true,
        title: true,
        date: true,
        location: true,
        attendanceEnabled: true,
      },
    });

    if (!event) {
      return NextResponse.json({ error: "Event not found" }, { status: 404 });
    }

    if (!event.attendanceEnabled) {
      return NextResponse.json(
        { error: "Attendance tracking is not enabled for this event" },
        { status: 400 }
      );
    }

    const baseUrl = getPublicBaseUrl(request);
    const attendanceUrl = `${baseUrl}/events/${eventId}/attend`;

    // Generate QR code as SVG string
    const qrCodeSvg = await QRCode.toString(attendanceUrl, {
      type: "svg",
      width: 300,
      margin: 1,
      color: {
        dark: "#1e3a5f",
        light: "#ffffff",
      },
    });

    // Format date
    const eventDate = new Date(event.date);
    const dateString = eventDate.toLocaleDateString("en-US", {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric",
    });
    const timeString = eventDate.toLocaleTimeString("en-US", {
      hour: "numeric",
      minute: "2-digit",
      timeZone: "America/New_York",
    });

    // Escape HTML entities in event title
    const escapeHtml = (str: string) =>
      str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    const safeTitle = escapeHtml(event.title);
    const safeLocation = event.location ? escapeHtml(event.location) : "";

    // Create SVG flyer (8.5x11 aspect ratio)
    const svgFlyer = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="850" height="1100" viewBox="0 0 850 1100">
  <!-- White background -->
  <rect width="850" height="1100" fill="#ffffff"/>
  
  <!-- Top decorative bars -->
  <rect x="0" y="0" width="850" height="12" fill="#426E8C"/>
  <rect x="0" y="12" width="850" height="6" fill="#5289AF"/>
  <rect x="0" y="18" width="850" height="4" fill="#86ACC7"/>
  
  <!-- SSE Logo -->
  <g transform="translate(205, 60)">
    <svg viewBox="39.76 133.315 441.771 101.759" width="442" height="102">
      <path fill="#1e3a5f" d="M172.605 159.691c-1.406-1.844-2.633-3.18-4.768-3.18-2.238 0-3.5 1.588-3.5 3.289 0 1.405.828 2.889 2.312 4.008 4.876 3.609 8.45 6.098 8.45 10.289a7.143 7.143 0 01-7.296 6.971c-3.575 0-5.917-1.972-7.835-5.492l2.204-1.341c1.548 2.855 3.451 4.299 5.423 4.299 2.712 0 4.802-1.972 4.802-4.407 0-2.85-2.672-4.477-8.558-9.244-1.228-.986-2.199-3.032-2.199-4.98 0-3.579 2.78-6.069 6.281-6.069 3.18 0 5.093 1.913 6.789 4.225l-2.105 1.632zM197.527 170.883c-.11 7.699-8.514 12.393-15.128 8.447-6.613-3.945-6.475-13.569.248-17.324a9.998 9.998 0 014.871-1.27c5.605-.054 10.14 4.544 10.009 10.147zm-17.473.034c0 4.191 3.141 7.622 7.474 7.622a7.454 7.454 0 007.474-7.622c0-4.26-3.396-7.799-7.474-7.799-4.077 0-7.484 3.539-7.484 7.799h.01zM219.796 176.552c-1.878 2.855-5.127 4.334-8.992 4.334-6.316 0-10.541-4.551-10.541-9.895 0-5.635 4.403-10.255 10.723-10.255 3.683 0 7.04 1.519 8.81 4.477l-1.972 1.228a8.244 8.244 0 00-6.932-3.323c-4.875 0-8.09 3.574-8.09 7.691 0 4.19 3.18 7.839 8.125 7.839a8.496 8.496 0 006.902-3.358l1.967 1.262zM226.945 155.357a2.08 2.08 0 01-2.061 2.056 2.045 2.045 0 01-2.021-2.056 2.016 2.016 0 012.021-2.021 2.051 2.051 0 012.061 2.021zm-3.254 5.887h2.465v19.174h-2.465v-19.174zM232.502 171.026c.108 4.407 3.106 7.622 7.222 7.622 4.009 0 5.917-2.278 7.332-4.585l2.06 1.079c-1.972 3.831-4.93 5.744-9.135 5.744-6.355 0-10.004-4.876-10.004-10.003 0-5.236 3.861-10.147 9.861-10.147 5.452 0 9.86 3.944 9.929 10.29h-17.265zm14.554-2.165c-.987-3.973-3.866-5.743-7.184-5.743-3.451 0-5.995 1.844-7.114 5.743h14.298zM254.89 154.09h2.465v7.154h3.944v2.145h-3.944v17.009h-2.465v-17.009h-3.397v-2.145h3.397v-7.154zM263.231 161.244h2.599l6.606 14.766 6.409-14.766h2.633l-11.477 26.179h-2.599l3.683-8.45-7.854-17.729zM313.741 170.883c-.11 7.699-8.514 12.393-15.127 8.448-6.613-3.946-6.476-13.57.248-17.325a10.012 10.012 0 014.881-1.27c5.6-.049 10.129 4.548 9.998 10.147zm-17.477.034c0 4.191 3.145 7.622 7.479 7.622a7.455 7.455 0 007.474-7.622c0-4.26-3.397-7.799-7.474-7.799s-7.479 3.539-7.479 7.799zM317.893 158.247c0-3.106.759-4.931 3.899-4.931a9.357 9.357 0 012.82.543v2.42a5.578 5.578 0 00-2.312-.576c-2.021 0-1.972 1.227-1.972 2.958v2.603h4.048v2.125h-4.048v17.009h-2.465v-17.009h-2.505v-2.145h2.525l.01-2.997zM164.371 208.254c1.193 2.238 2.564 3.396 4.299 3.396 1.662 0 2.998-1.084 2.998-2.42 0-.937-.616-2.022-1.662-2.889-5.379-4.497-8.558-6.962-8.558-10.664 0-3.703 3.214-6.533 7.114-6.533 3.283 0 5.453 1.77 7.508 4.151l-3.687 3.249c-1.228-1.73-2.49-2.672-3.9-2.672-1.297 0-2.199.759-2.199 1.805 0 1.045.754 1.661 1.514 2.312 4.841 4.265 8.701 6.286 8.701 11.014 0 4.334-3.249 7.366-7.942 7.366-3.791 0-6.409-1.839-8.342-5.631l4.156-2.484zM198.641 206.114c-.012 7.742-8.401 12.568-15.1 8.687-6.699-3.882-6.684-13.56.027-17.421a10.06 10.06 0 014.887-1.339c5.625-.108 10.231 4.447 10.186 10.073zm-15.284 0c0 3.249 2.061 5.561 5.167 5.561 2.958 0 5.271-2.164 5.271-5.522 0-3.254-2.13-5.561-5.271-5.561-2.992 0-5.162 2.347-5.162 5.522h-.005zM200.371 196.544h1.731c.034-4.294-.394-7.888 4.659-7.888a9.16 9.16 0 013.392.685v3.688a6.044 6.044 0 00-1.731-.325c-1.878 0-1.479.986-1.518 3.86h3.037v4.082h-3.047v15.092h-4.802v-15.111h-1.73l.009-4.083zM214.669 189.47h4.802v7.074h2.85v4.117h-2.85v15.057h-4.802v-15.057h-2.465v-4.117h2.465v-7.074zM223.691 196.544h4.733l3.826 10.906 4.156-10.906h2.889l4.083 10.763 3.865-10.763h4.728l-6.966 19.174h-3.072l-4.082-10.916-4.225 10.941h-2.998l-6.937-19.199zM267.092 213.677a7.96 7.96 0 01-5.916 2.529c-4.871 0-9.136-4.191-9.136-10.072 0-5.996 4.048-10.112 9.027-10.112a8.239 8.239 0 016.03 2.598v-2.095h4.807v19.173h-4.812v-2.021zm-10.216-7.583c0 3.289 2.165 5.704 5.162 5.704 2.998 0 5.271-2.238 5.271-5.738 0-3.358-2.239-5.636-5.271-5.636-3.175.02-5.162 2.549-5.162 5.69v-.02zM279.767 198.965c.903-1.972 2.465-2.924 4.043-2.924a4.524 4.524 0 012.095.494l-1.479 4.116a3.443 3.443 0 00-1.41-.394c-1.37 0-2.465 1.587-2.563 4.402-.035 1.051-.035 2.239-.035 3.289v7.76h-4.807v-19.164h4.156v2.421zM305.439 212.001c-2.056 2.923-4.768 4.225-8.81 4.225-6.104 0-10.038-4.477-10.038-10.112 0-5.236 3.791-10.073 9.964-10.073 6.069 0 10.186 4.334 10.186 10.398 0 .434-.04.651-.04 1.085H291.25c.468 2.85 2.633 4.437 5.379 4.437a6.206 6.206 0 004.767-1.878l4.043 1.918zm-3.54-8.268c-.651-2.239-2.707-3.614-5.27-3.614-2.382 0-4.226 1.193-5.162 3.614h10.432zM321.275 189.795h14.154v4.836h-9.224v4.625h9.205v4.836h-9.205v6.789h9.205v4.837h-14.135v-25.923zM343.89 198.497c1.843-1.553 3.539-2.465 5.669-2.465 3.575 0 6.572 2.465 6.572 6.572v13.104h-4.782v-9.052c0-3.791-.325-6.212-3.249-6.212a3.757 3.757 0 00-3.249 1.844c-.986 1.553-.942 3.284-.942 5.27v8.16h-4.802v-19.174h4.802l-.019 1.953zM378.84 212.977c0 3.717-.72 6.212-2.924 8.085-1.73 1.445-4.043 2.135-6.966 2.135-5.276 0-8.633-2.061-9.935-6.069h5.31c.986 1.154 2.421 1.661 4.437 1.661 1.77 0 3.215-.493 4.083-1.262 1.153-1.084 1.188-2.386 1.188-4.19a7.723 7.723 0 01-5.813 2.381c-5.162 0-9.21-4.117-9.21-9.86 0-5.917 4.083-9.821 8.959-9.821 2.381 0 4.259.902 6.064 2.598v-2.096h4.802l.005 16.438zm-14.983-7.08c0 3.18 2.273 5.423 5.27 5.423 2.998 0 5.167-2.13 5.167-5.379 0-3.106-2.061-5.492-5.236-5.492s-5.201 2.49-5.201 5.448zM388.325 191.816a3.066 3.066 0 01-3.071 3.067 3.19 3.19 0 01-3.067-3.318 2.993 2.993 0 013.067-2.929 3.116 3.116 0 013.071 3.18zm-5.452 4.728h4.802v19.174h-4.802v-19.174zM396.421 198.497c1.844-1.553 3.54-2.465 5.67-2.465 3.574 0 6.572 2.465 6.572 6.572v13.104h-4.802v-9.052c0-3.791-.326-6.212-3.249-6.212a3.768 3.768 0 00-3.249 1.844c-.987 1.553-.942 3.284-.942 5.27v8.16h-4.802v-19.174h4.802v1.953zM430.365 212.001c-2.061 2.923-4.767 4.225-8.81 4.225-6.104 0-10.043-4.477-10.043-10.112 0-5.236 3.792-10.073 9.969-10.073 6.064 0 10.181 4.334 10.181 10.398 0 .434-.035.651-.035 1.085h-15.456c.469 2.85 2.638 4.437 5.384 4.437a6.198 6.198 0 004.763-1.878l4.047 1.918zm-3.54-8.268c-.65-2.239-2.706-3.614-5.27-3.614-2.386 0-4.225 1.193-5.167 3.614h10.437zM452.911 212.001c-2.061 2.923-4.767 4.225-8.81 4.225-6.104 0-10.038-4.477-10.038-10.112 0-5.236 3.791-10.073 9.964-10.073 6.069 0 10.186 4.334 10.186 10.398 0 .434-.04.651-.04 1.085h-15.436c.493 2.85 2.637 4.437 5.384 4.437a6.206 6.206 0 004.767-1.878l4.023 1.918zm-3.54-8.268c-.651-2.239-2.706-3.614-5.27-3.614-2.386 0-4.225 1.193-5.167 3.614h10.437zM461.09 198.965c.903-1.972 2.465-2.924 4.043-2.924a4.524 4.524 0 012.095.494l-1.479 4.116a3.42 3.42 0 00-1.405-.394c-1.375 0-2.465 1.587-2.563 4.402-.04 1.051-.04 2.239-.04 3.289v7.76h-4.802v-19.164h4.156l-.005 2.421zM473.258 207.415c-3.072-1.553-4.625-3.451-4.625-5.852 0-2.997 2.53-5.522 6.213-5.522a7.809 7.809 0 016.32 3.176l-2.958 2.997c-1.085-1.085-2.164-1.77-3.323-1.77-.986 0-1.731.399-1.731 1.159 0 .759.686 1.045 1.731 1.587l1.77.902c3.18 1.627 4.876 3.289 4.876 6.139 0 3.451-2.707 5.995-6.902 5.995a8.095 8.095 0 01-6.715-3.289l2.958-3.249c1.119 1.302 2.746 2.239 4.008 2.239s2.13-.686 2.13-1.553c0-.868-.794-1.445-2.13-2.13l-1.622-.829z"/>
      <path fill="#426E8C" d="M39.76 215.876L39.76 203.767 79.789 218.863 79.789 206.474 39.76 191.299 39.76 154.288 89.664 173.18 89.664 185.476 49.685 170.395 49.69 182.789 89.664 197.905 89.664 235.074 39.76 215.876z"/>
      <path fill="#5289AF" d="M142.249 166.662L101.94 181.547 101.94 193.986 122.095 186.689 122.095 198.797 101.905 206.602 101.905 218.74 142.249 203.915 142.249 215.871 91.7 235.074 91.7 173.131 142.249 154.278 142.249 166.662z"/>
      <path fill="#86ACC7" d="M40.756 152.232L90.704 133.315 101.003 137.16 61.098 152.232 70.88 155.939 111.007 140.823 141.273 152.217 90.66 171.154 80.844 167.372 120.842 152.237 111.209 148.465 70.747 163.571 40.756 152.232z"/>
    </svg>
  </g>
  
  <!-- Event Title -->
  <text x="425" y="280" font-family="Arial, sans-serif" font-size="48" font-weight="bold" fill="#1e3a5f" text-anchor="middle">${safeTitle}</text>
  
  <!-- Date and Time -->
  <text x="425" y="340" font-family="Arial, sans-serif" font-size="24" fill="#426E8C" text-anchor="middle">${dateString}</text>
  <text x="425" y="375" font-family="Arial, sans-serif" font-size="20" fill="#5289AF" text-anchor="middle">${timeString} EST</text>
  
  ${safeLocation ? `<text x="425" y="415" font-family="Arial, sans-serif" font-size="20" fill="#666666" text-anchor="middle">${safeLocation}</text>` : ""}
  
  <!-- Scan to Check In -->
  <text x="425" y="500" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="#426E8C" text-anchor="middle">Scan to Check In</text>
  
  <!-- QR Code -->
  <g transform="translate(275, 530)">
    ${qrCodeSvg}
  </g>
  
  <!-- Bottom decorative bars -->
  <rect x="0" y="1078" width="850" height="4" fill="#86ACC7"/>
  <rect x="0" y="1082" width="850" height="6" fill="#5289AF"/>
  <rect x="0" y="1088" width="850" height="12" fill="#426E8C"/>
  
  <!-- Footer -->
  <text x="425" y="1060" font-family="Arial, sans-serif" font-size="14" fill="#999999" text-anchor="middle">sse.rit.edu</text>
</svg>`;

    return new NextResponse(svgFlyer, {
      status: 200,
      headers: {
        "Content-Type": "image/svg+xml",
        "Content-Disposition": `attachment; filename="flyer-${event.title.replace(/[^a-zA-Z0-9]/g, "-")}.svg"`,
        "Cache-Control": "no-cache, no-store, must-revalidate",
      },
    });
  } catch (error) {
    console.error("Error generating flyer:", error);
    return NextResponse.json(
      { error: "Failed to generate flyer: " + (error as Error).message },
      { status: 500 }
    );
  }
}
